<?php


$message =

    str_get_html('<html>
                    <head>
                        <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
                        <title>Plaisir Rando 2P Mot de passe réinitialisé</title>
                        <style type="text/css">
                        body, div, table, thead, tbody, tfoot, tr, th, td, p {
                            font-family: "Helvetica Neue";
                            font-size: x-small
                        }
                        a.comment-indicator:hover + comment {
                            background: #ffd;
                            position: absolute;
                            display: block;
                            border: 1px solid black;
                            padding: 0.5em;
                        }
                        a.comment-indicator {
                            background: red;
                            display: inline-block;
                            border: 1px solid black;
                            width: 0.5em;
                            height: 0.5em;
                        }
                        comment {
                            display: none;
                        }
                        </style>
                    </head>
                    <body>
                        <table cellspacing="0" border="0">
                            <colgroup span="5" width="136"></colgroup>
                            <colgroup width="177"></colgroup>
                            <colgroup width="136"></colgroup>
                            <tr>
                                <td height="113" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                            </tr>
                            <tr>
                                <td style="border-bottom: 1px solid #483b33" colspan=7 height="88" align="center" valign=top bgcolor="#483B33" sdnum="1036;0;@">
                                    <b>
                                        <font face="Helvetica" size=7 color="#FFFFFF">Plaisir Rando </font>
                                        <font face="Helvetica" size=7 color="#B4CF66">2P</font>
                                    </b>
                                </td>
                            </tr>
                            <tr>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-right: 1px solid #483b33" height="147" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33; border-right: 1px solid #483b33" colspan=5 align="center" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" size=3 color="#FFFFFF">
                                        Votre mot de passe Espace Adhérent Plaisir Rando à été réinitialisé !
                                        <br>
                                        <br>
                                        Utilisez le lien et mot de passe ci-dessous pour vous connecter à votre espace adhérent.
                                        <br>
                                        Un nouveau mot de passe vous sera alors demandé à la première connexion.  
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                            </tr>
                            <tr>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-right: 1px solid #483b33" height="51" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33; border-right: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33; border-right: 1px solid #483b33" colspan=3 align="center" valign=middle bgcolor="#483B33" sdnum="1036;0;@">
                                    <font face="Helvetica" color="#FFFFFF">Votre Mot de passe temporaire</font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33; border-right: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                            </tr>
                            <tr>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-right: 1px solid #483b33" height="101" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33; border-right: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33; border-right: 1px solid #483b33" colspan=3 align="center" valign=middle bgcolor="#483B33" sdnum="1036;0;@">
                                    <b>
                                        <font face="Helvetica" size=6 color="#B4CF66" id="password">e8gr35</font>
                                    </b>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33; border-right: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                            </tr>
                            <tr>
                                <td style="border-bottom: 1px solid #483b33; border-right: 1px solid #483b33" height="32" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-bottom: 1px solid #483b33; border-left: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td colspan=3 align="center" valign=middle bgcolor="#FFFFFF" sdnum="1036;0;@">
                                    <font face="Helvetica" color="#483B33">Connexion à mon espace adhérent </font>
                                </td>
                                <td style="border-bottom: 1px solid #483b33; border-right: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-bottom: 1px solid #483b33; border-left: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                            </tr>
                            <tr>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-right: 1px solid #483b33" height="77" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td colspan=3 align="center" valign=top bgcolor="#FFFFFF" sdnum="1036;0;@">
                                    <font face="Helvetica" color="#000">
                                        <a href="https://plaisir-rando2p.re/participer">https://plaisir-rando2p.re/participer</a>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-right: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                                <td style="border-top: 1px solid #483b33; border-bottom: 1px solid #483b33; border-left: 1px solid #483b33" align="left" valign=top bgcolor="#483B33">
                                    <font face="Helvetica" color="#FFFFFF">
                                        <br>
                                    </font>
                                </td>
                            </tr>
                        </table>
                        <!-- ************************************************************************** -->
                    </body>
                </html>');

$UI_PROFIL  = $template->find('[id=profilform]', 0);
$UI_COTISE  = $template->find('[id=cotisation]', 0);
$UI_FAMILY  = $template->find('[id=groupe]', 0);

if ((isset($_POST) && !empty($_POST))) {

    /***********************************
     * 
     *      POST
     * 
     ***********************************/
    if($_POST['action'] == 'export'){
        $_GET_USERS = SELECT('adherent', '*', 'WHERE status = 1');
        
    }
    if ($_POST['action'] == 'editUser') {

        $DATA_ARRAY = array(
            'email'     => ENCRYPT(CLEAN($_POST['email'])),
            'nom'       => ENCRYPT(CLEAN($_POST['unom'])),
            'prenom'    => ENCRYPT(CLEAN($_POST['prenom'])),
            'adresse'   => ENCRYPT(CLEAN($_POST['adresse'])),
            'cp'        => ENCRYPT(CLEAN($_POST['cp'])),
            'ville'     => ENCRYPT(CLEAN($_POST['ville'])),
            'tel'       => ENCRYPT(CLEAN($_POST['tel'])),
            'tel2'      => ENCRYPT(CLEAN($_POST['tel2'])),
            'note'      => ENCRYPT(CLEAN($_POST['note'])),
            'genre'     => (CLEAN($_POST['genre'])),
            'adherent'  => CLEAN($_POST['noadherent'])
        );

        if (isset($_POST['password']) && !empty($_POST['password'])) {
            $DATA_ARRAY['password'] = password_hash($_POST['password'], PASSWORD_DEFAULT);

            //If status = 3 propose to change password then back to 1
            $DATA_ARRAY['status']   = 3;


            $message->find('[id=password]', 0)->innertext = $_POST['password'];




            // if (sendMail($_POST['email'], 'Vos Identifiants Plaisir Rando 2P', $message->outertext, 'ne-pas-repondre@plaisir-rando2P.re')) {
            //     echo 'ok';
            // } else {
            //     echo 'nok';
            // }


            // $subject = $_POST['sujet'];
            // $message = $_POST['informations'];

            // Pour envoyer un mail HTML, l'en-tête Content-type doit être défini
            $headers  = 'MIME-Version: 1.0' . "\r\n";
            $headers .= 'Content-type: text/html; charset=iso-8859-1' . "\r\n";

            // En-têtes additionnels
            $headers .= 'From: Plaisir Rando 2P <plaisir-rando2p@gmail.com>' . "\r\n";

            // Envoi
            mail($_POST['email'], 'Vos Identifiants Plaisir Rando 2P', $message->outertext, $headers);


        }

        $UPDATE_USER = UPDATE('adherents', $DATA_ARRAY, 'WHERE id=' . CLEAN($_POST['uid']), false);

        if ($UPDATE_USER) {
            $checker->innertext = 'La modification a été effectuée avec succès';
            $checker->addClass('green');
        } else {
            $checker->innertext = 'Une erreur est survenue lors de la modification';
            $checker->addClass('red');
        }
    }
    if ($_POST['action'] == 'addUser') {
        $DATA_ARRAY = array(
            'email'     => ENCRYPT(CLEAN($_POST['email'])),
            'nom'       => ENCRYPT(CLEAN($_POST['unom'])),
            'prenom'    => ENCRYPT(CLEAN($_POST['prenom'])),
            'adresse'   => ENCRYPT(CLEAN($_POST['adresse'])),
            'cp'        => ENCRYPT(CLEAN($_POST['cp'])),
            'ville'     => ENCRYPT(CLEAN($_POST['ville'])),
            'tel'       => ENCRYPT(CLEAN($_POST['tel'])),
            'tel2'      => ENCRYPT(CLEAN($_POST['tel2'])),
            'note'      => ENCRYPT(CLEAN($_POST['note'])),
            'genre'     => (CLEAN($_POST['genre'])),
            'type'      => 2,
            'status'    => 1,
            'date'      => date('Y-m-d H:i:s'),
            'adherent'  => CLEAN($_POST['noadherent'])
        );
        
        if (isset($_POST['password']) && !empty($_POST['password'])) {
            $DATA_ARRAY['password'] = password_hash($_POST['password'], PASSWORD_DEFAULT);

            //If status = 3 propose to change password then back to 1
            $DATA_ARRAY['status']   = 3;
        }
        $ADD_USER = INSERT('adherents', $DATA_ARRAY, false);
        if ($ADD_USER) {
            $checker->innertext = "L'adhérent a été créé avec succès";
            $checker->addClass('green');
        } else {
            $checker->innertext = "Une erreur est survenue";
            $checker->addClass('red');
        }
    }
    if ($_POST['action'] == 'cotiser') {
        $INSERT_COTISATIONS = INSERT('queue_cotisations', array(
            'date'     => date('Y-m-d H:i:s'),
            'start'    => CLEAN($_POST['start'] . ' 00:00:00'),
            'end'      => CLEAN($_POST['end'] . ' 00:00:00'),
            'mode'     => CLEAN($_POST['mode']),
            'status'   => CLEAN($_POST['status']),
            'amount'   => CLEAN($_POST['montant']),
            'userID'   => CLEAN($_POST['uid']),
            'note'     => CLEAN(ENCRYPT($_POST['note']))
        ), false);

        if ($INSERT_COTISATIONS) {
            $checker->innertext = "La cotisation a été ajoutée avec succès";
            $checker->addClass('green');
        } else {
            $checker->innertext = "Une erreur est survenue lors de l'ajout de la cotisation";
            $checker->addClass('red');
        }
    }
    if ($_POST['action'] == 'add2Group') {

        // $SQL = "UPDATE articles SET `images` = (SELECT json_remove(images, '$." . CLEAN($_POST['iid']) . "') WHERE id=" . CLEAN($_POST['role']) . ")  WHERE id=" . CLEAN($_POST['role']);
        $SQL =  "UPDATE adherents SET groupe = JSON_SET(groupe, '$." . date('YmdHis') . "', json('" . json_encode(array(
            'nom'    => ENCRYPT(CLEAN($_POST['fnom'])),
            'prenom' => ENCRYPT(CLEAN($_POST['fprenom'])),
            'ddn'    => ENCRYPT(CLEAN($_POST['fdate']))
        )) . "')) where id = " . CLEAN($_POST['aid']);


        $result = sqlite_query($connection, $SQL);

        if ($result) {
            $checker->innertext = "La personne a été joint à l'adhérent avec succès";
            $checker->addClass('yellow');
        } else {
            $checker->innertext = "Une erreur est survenue lors de l'ajout de la personne à l'adhérent";
            $checker->addClass('red');
        }
    }
    if ($_POST['action'] == 'remove2Group') {
        $SQL = "UPDATE adherents SET groupe = JSON_REMOVE(groupe, '$." . CLEAN($_POST['fid']) . "') WHERE id=" . CLEAN($_POST['aid']);
        $result = sqlite_query($connection, $SQL);

        if ($result) {
            $checker->innertext = "La personne a été retirée de l'adhérent avec succès";
            $checker->addClass('yellow');
        } else {
            $checker->innertext = "Une erreur est survenue lors de la suppression de la personne de l'adhérent";
            $checker->addClass('red');
        }
    }
    if ($_POST['action'] == 'open') {
        $template->find('[id=toggle-modal1]', 0)->{'checked'} = "checked";

        // echo "<pre>";
        // print_r($_POST);
        // echo "</pre>";
        $UI_COTISE->innertext = "Validez le profil avant de pouvoir ajouter une cotisation";
        $UI_FAMILY->innertext = "Validez le profil avant de pouvoir y ajouter une personne";
    }
} else {

    /***********************************
     * 
     *      GET
     * 
     ***********************************/
}

/***********************************
 * 
 *      BOTH
 * 
 ***********************************/


//BIG table

$TABLE     = $template->find('tbody', 0);
$TR        = $TABLE->find('tr', 0);
$GET_USERS = SELECT(
    'adherents',
    'adherents.*,
    (SELECT queue_cotisations.status FROM queue_cotisations WHERE userID = adherents.id ORDER BY date DESC LIMIT 1) as queue_status',
    'WHERE 1 ORDER BY date ASC',
    false
);

if ($GET_USERS) {
    $STACK_TR = (string) null;
    while ($DATA = fetch_array($GET_USERS)) {

        $TR->find('td', 0)->innertext               = ((function ($DATA) {
            switch ($DATA['genre']) {
                case '0':
                    return 'M.';
                case '1':
                    return 'Mme';
                default:
                    return '--';
            }
        })($DATA));

        $parseGroup = (function ($DATA) {
            $group = json_decode($DATA['groupe'], true);

            $array = (array) null;

            foreach ($group as $people) {
                $array[] = DECRYPT($people['nom']) . ' , ' . DECRYPT($people['prenom']);
            }

            return (!empty($group) ? '<span class="status">+' . count($group) . '<i class="fal fa-user"></i></span> <span class="text-1 d-none">' . implode(' ; ', $array) . '</span>' : '');
        })($DATA);

        $TR->find('td', 1)->find('a', 0)->{'href'}  = url('manager_users', true) . '&a=' . $DATA['id'];
        $TR->find('td', 1)->find('a', 0)->{'data-action'}  = url('manager_users', true) . '&a=' . $DATA['id'];
        $TR->find('td', 1)->find('a', 0)->innertext = DECRYPT($DATA['nom']) . ', ' . DECRYPT($DATA['prenom']);
        $TR->find('td',               2)->innertext = dateToFrench($DATA['date'], 'l j F Y');
        $TR->find('td',               3)->find('span', 0)->innertext = DECRYPT($DATA['email']);
        $TR->find('td',               3)->find('span', 1)->innertext = DECRYPT($DATA['tel']);
        $TR->find('td',               4)->innertext                  = $parseGroup;
        $TR->find('td',               5)->find('span', 0)->innertext = $DATA['queue_status'] == '1' ? 'Complet' : 'Incomplet';
        $TR->find('td',               5)->find('span', 0)->{'class'} = $DATA['queue_status'] == '1' ? 'status one' : 'status two';
        $TR->find('td',               6)->innertext                  = $DATA['adherent'];
        $TR->find('td',              -1)->find('span', 0)->innertext = $DATA['status'] == '1' ? 'Actif' : 'Inactif';


        $STACK_TR .= $TR;
    }
    $TABLE->innertext = $STACK_TR;
}




if (isset($_GET['a']) && !empty($_GET['a'])) {
    $template->find('[id=toggle-modal1]', 0)->{'checked'} = "checked";
    //Fill Side panel

    $GET_PROFIL = SELECT('adherents', '*', 'WHERE id=' . CLEAN($_GET['a']), false);

    if ($GET_PROFIL) {

        while ($DATA = fetch_array($GET_PROFIL)) {
            $UI_PROFIL->find('h3', 0)->find('span', 0)->innertext = DECRYPT($DATA['nom']);
            $UI_PROFIL->find('h3', 0)->find('span', 1)->innertext = DECRYPT($DATA['prenom']);

            $UI_PROFIL->find('[name=noadherent]',       0)->value = ($DATA['adherent']);

            $UI_PROFIL->find('[name=unom]',             0)->value = DECRYPT($DATA['nom']);
            $UI_PROFIL->find('[name=prenom]',           0)->value = DECRYPT($DATA['prenom']);
            $UI_PROFIL->find('[name=adresse]',          0)->value = DECRYPT($DATA['adresse']);
            $UI_PROFIL->find('[name=cp]',               0)->value = DECRYPT($DATA['cp']);
            $UI_PROFIL->find('[name=ville]',            0)->value = DECRYPT($DATA['ville']);
            $UI_PROFIL->find('[name=tel]',              0)->value = DECRYPT($DATA['tel']);
            $UI_PROFIL->find('[name=tel2]',             0)->value = DECRYPT($DATA['tel2']);
            $UI_PROFIL->find('[name=note]',             0)->value = DECRYPT($DATA['note']);
            $UI_PROFIL->find('[name=email]',            0)->value = DECRYPT($DATA['email']);
            $UI_PROFIL->find('[name=genre]',    $DATA['genre'])->{'checked'} = 'checked';

            //User ID
            $UI_PROFIL->find('[name=uid]',    0)->value = $DATA['id'];
            $UI_COTISE->find('[name=uid]',    0)->value = $DATA['id'];

            //User names
            // $template->find('.user h3',      0)->innertext = DECRYPT($DATA['nom']) . ' ' . DECRYPT($DATA['prenom']);
            // $template->find('[id=profil]',      0)->find('span', 0)->innertext .= ' (' . DECRYPT($DATA['nom']) . ' ' . DECRYPT($DATA['prenom']) . ')';
            // $template->find('[id=cotisations]', 0)->find('span', 0)->innertext .= ' (' . DECRYPT($DATA['nom']) . ' ' . DECRYPT($DATA['prenom']) . ')';

            //Famille
            $UI_F_TBODY = $UI_FAMILY->find('tbody', 0);
            $UI_F_TR    = $UI_F_TBODY->find('tr', 0);

            //User ID for Family
            $UI_FAMILY->find('[name=aid]',    0)->value = $DATA['id'];
            $TR_STACK = (string) null;
            foreach (json_decode($DATA['groupe'], true) as $index => $people) {

                $UI_F_TR->find('td', 0)->innertext = DECRYPT($people['nom']) . ', ' . DECRYPT($people['prenom']);
                $UI_F_TR->find('td', 1)->innertext = dateToFrench(DECRYPT($people['ddn']), 'd/m/Y');

                foreach ($UI_F_TR->find('td') as $td) {
                    $td->{'data-group'} = $index;
                    $td->{'data-aid'}   = $DATA['id'];
                    $td->{'data-post'}  = '#checkbar, #groupe';
                    $td->{'data-action'} = url('manager_users', true) . '&a=' . $DATA['id'];
                }

                $TR_STACK .= $UI_F_TR;
            }

            $UI_F_TBODY->innertext = $TR_STACK;

            if (!isset($_GET['a'])) {
                $checker->innertext = 'Ouverture du profil de ' . DECRYPT($DATA['nom']) . ' ' . DECRYPT($DATA['prenom']);
                $checker->{'class'} .= ' blue';
            }
        }

        //Transforme addUser en editUser
        $UI_PROFIL->find('[value=addUser]', 0)->value = 'editUser';


        $GET_COTIZ = SELECT('queue_cotisations', '*', 'WHERE userID=' . CLEAN($_GET['a']) . ' ORDER BY date DESC', false);
        if ($GET_COTIZ) {

            $UI_TBODY = $UI_COTISE->find('tbody', 0);
            $UI_TR    = $UI_TBODY->find('tr', 0);
            $i = 1;

            $STACK_TR = (string) null;
            while ($DATA = fetch_array($GET_COTIZ)) {
                $UI_TR->find('td', 0)->innertext = $i;

                $UI_TR->find('td', 1)->{'title'} = 'Enregistré le ' . dateToFrench($DATA['date'], 'd/m/Y H:i');
                $UI_TR->find('td', 1)->innertext = dateToFrench($DATA['start'], 'd/m/Y');

                $UI_TR->find('td', 2)->{'title'} = 'Du ' . dateToFrench($DATA['start'], 'd/m/Y') . ' au ' . dateToFrench($DATA['end'], 'd/m/Y');
                $UI_TR->find('td', 2)->innertext = DATEDIFF($DATA['end'], $DATA['start']) . ' jours';

                $UI_TR->find('td', 3)->find('span', 0)->innertext =  '(' . STR_PAD($DATA['amount'], 3, ' ', STR_PAD_LEFT) . '€)';

                $UI_TR->find('td', 3)->find('span', 1)->innertext = (function ($DATA) {
                    switch ($DATA['mode']) {
                        case '0':
                            return 'Espèces';
                        case '1':
                            return 'CB';
                        case '2':
                            return 'Chèque';
                        case '3':
                            return 'Virement';
                    }
                })($DATA);
                $UI_TR->find('td', 4)->find('span', 0)->innertext = ((function ($DATA) {
                    switch ($DATA['status']) {
                        case '0':
                            return 'Incomplet';
                        case '1':
                            return 'Complet';
                    }
                })($DATA));
                $UI_TR->find('td', 4)->find('span', 0)->{'class'} = 'status ' . ((function ($DATA) {
                    switch ($DATA['status']) {
                        case '0':
                            return 'two';
                        case '1':
                            return 'one';
                    }
                })($DATA));
                $UI_TR->find('td',  5)->innertext = DECRYPT($DATA['note']);
                $UI_TR->find('td', -1)->innertext = DATEDIFF($DATA['start'], $DATA['end']) > 0 ? 'Valide' : 'Expiré';
                $STACK_TR .= $UI_TR;
                $i++;
            }
            $UI_TBODY->innertext = $STACK_TR;
        }
    }


    //Open or close details
    // $template->find('[id=side]', 0)->find('details', 1)->{'open'} = true;
} else {
    //Open or close details
    // $template->find('[id=side]', 0)->find('details', 0)->{'open'} = true;
}
